<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class TaskQueueSQS - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/task_queues/task_queue_sqs.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link"><a href="TaskQueue.html">TaskQueue</a>
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-get_creds">#get_creds</a>
    
    <li><a href="#method-i-pop">#pop</a>
    
    <li><a href="#method-i-push">#push</a>
    
    <li><a href="#method-i-size">#size</a>
    
    <li><a href="#method-i-to_s">#to_s</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./Datastore.html">Datastore</a>
  
    <li><a href="./DatastoreFactory.html">DatastoreFactory</a>
  
    <li><a href="./DatastoreRepo.html">DatastoreRepo</a>
  
    <li><a href="./DatastoreRepoOnAppEngine.html">DatastoreRepoOnAppEngine</a>
  
    <li><a href="./DatastoreRepoOnAppScale.html">DatastoreRepoOnAppScale</a>
  
    <li><a href="./DatastoreS3.html">DatastoreS3</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./EngineFactory.html">EngineFactory</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GoogleAppEnginePullQueue.html">GoogleAppEnginePullQueue</a>
  
    <li><a href="./GoogleAppEnginePushQueue.html">GoogleAppEnginePushQueue</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./NeptuneJobData.html">NeptuneJobData</a>
  
    <li><a href="./NeptuneManager.html">NeptuneManager</a>
  
    <li><a href="./NeptuneManagerServer.html">NeptuneManagerServer</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./QueueFactory.html">QueueFactory</a>
  
    <li><a href="./TaskEngine.html">TaskEngine</a>
  
    <li><a href="./TaskEngineAppScale.html">TaskEngineAppScale</a>
  
    <li><a href="./TaskEngineGoogleAppEngine.html">TaskEngineGoogleAppEngine</a>
  
    <li><a href="./TaskQueue.html">TaskQueue</a>
  
    <li><a href="./TaskQueueAzureQueue.html">TaskQueueAzureQueue</a>
  
    <li><a href="./TaskQueueGoogleAppEngine.html">TaskQueueGoogleAppEngine</a>
  
    <li><a href="./TaskQueueRabbitMQ.html">TaskQueueRabbitMQ</a>
  
    <li><a href="./TaskQueueSQS.html">TaskQueueSQS</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
    <li><a href="./ZooKeeperLockException.html">ZooKeeperLockException</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class TaskQueueSQS</h1>

  <div id="description" class="description">
    
<p><a href="TaskQueueSQS.html">TaskQueueSQS</a> provides a simple interface
(implementing <a href="TaskQueue.html">TaskQueue</a>) to Amazon’s Simple
Queue Service (SQS). SQS is externally managed and hosted by Amazon, so we
don’t have to worry about deploying it. TODO(cgb): SQS is eventually
consistent, so it is possible that we could receive the same message twice,
and thus execute the same task twice.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="NAME">NAME
        
        <dd class="description"><p>The name of this queue. Since we always use our Executor to run tasks, and
store task info in SQS, we call it ‘executor-sqs’.</p>
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-EC2_ACCESS_KEY" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">EC2_ACCESS_KEY</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The access key, provided by AWS, that is required to access SQS.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-EC2_SECRET_KEY" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">EC2_SECRET_KEY</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>The secret key, provided by AWS, that is required to access SQS.</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-get_creds" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_creds</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns all the credentials needed to access this queue. For SQS, it’s 
just the access key and secret key</p>
          

          
          <div class="method-source-code" id="get_creds-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 93</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_creds</span>()
  <span class="ruby-keyword">return</span> {<span class="ruby-string">'@EC2_ACCESS_KEY'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@EC2_ACCESS_KEY</span>,
    <span class="ruby-string">'@EC2_SECRET_KEY'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@EC2_SECRET_KEY</span>}
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_creds-source -->
          
        </div>

        

        
      </div><!-- get_creds-method -->

    
      <div id="method-i-pop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">pop</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Retrieves an item from the queue, returning the Hash version of the
JSON-dumped data. We should be the only ones writing to the queue, but just
in case we aren’t, we need to validate that the data we’re receiving
from the queue is data that we can load via JSON. TODO(cgb): Receiving and
deleting the message isn’t an atomic operation, and since SQS is
eventually consistent, could this result in two readers getting the same
item? If so, would using a lock on the queue (making the operation atomic)
solve the problem?</p>
          

          
          <div class="method-source-code" id="pop-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 78</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">pop</span>()
  <span class="ruby-identifier">json_item</span> = <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">receive_message</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">json_item</span>.<span class="ruby-identifier">nil?</span>  <span class="ruby-comment"># occurs when the queue is empty</span>
  <span class="ruby-identifier">json_item</span>.<span class="ruby-identifier">delete</span>()

  <span class="ruby-keyword">begin</span>
    <span class="ruby-keyword">return</span> <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">load</span>(<span class="ruby-identifier">json_item</span>.<span class="ruby-identifier">body</span>())
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">JSON</span><span class="ruby-operator">::</span><span class="ruby-constant">ParserError</span>  <span class="ruby-comment"># if somebody else wrote a non-JSON item</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">pop</span>()
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- pop-source -->
          
        </div>

        

        
      </div><!-- pop-method -->

    
      <div id="method-i-push" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">push</span><span
            class="method-args">(item)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Stores a Hash in the queue for later processing. Since SQS can’t store
items in Hash format, we use the JSON library to dump it to a string, which
SQS can store.</p>
          

          
          <div class="method-source-code" id="push-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">push</span>(<span class="ruby-identifier">item</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">item</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Hash</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">json_item</span> = <span class="ruby-constant">JSON</span>.<span class="ruby-identifier">dump</span>(<span class="ruby-identifier">item</span>)
  <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">send_message</span>(<span class="ruby-identifier">json_item</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- push-source -->
          
        </div>

        

        
      </div><!-- push-method -->

    
      <div id="method-i-size" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">size</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns the number of messages in the queue, which in SQS is the number of
visible messages (there should be no invisible messages since we always
immediately delete messages upon receiving them).</p>
          

          
          <div class="method-source-code" id="size-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 102</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">size</span>()
  <span class="ruby-keyword">return</span> <span class="ruby-ivar">@queue</span>.<span class="ruby-identifier">visible_messages</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- size-source -->
          
        </div>

        

        
      </div><!-- size-method -->

    
      <div id="method-i-to_s" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">to_s</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>returns a string representation of this queue, which is just the queue name
and the credentials TODO(cgb): this seems generic enough to move into <a
href="TaskQueue.html">TaskQueue</a>, so do so</p>
          

          
          <div class="method-source-code" id="to_s-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">to_s</span>()
  <span class="ruby-identifier">access_key</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">obscure_string</span>(<span class="ruby-ivar">@EC2_ACCESS_KEY</span>)
  <span class="ruby-identifier">secret_key</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">obscure_string</span>(<span class="ruby-ivar">@EC2_SECRET_KEY</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-node">&quot;Queue type: SQS, EC2_ACCESS_KEY: #{access_key}, &quot;</span> <span class="ruby-operator">+</span>
    <span class="ruby-node">&quot;EC2_SECRET_KEY: #{secret_key}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- to_s-source -->
          
        </div>

        

        
      </div><!-- to_s-method -->

    
    </section><!-- public-instance-method-details -->
  
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(credentials)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Creates a new SQS queue connection and queue to store / retrieve tasks
with, via the AWS RubyGem. We pull in the AWS RubyGem instead of the
RightScale AWS RubyGem since the RightScale gem doesn’t work with the
current version of SQS.</p>
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/task_queues/task_queue_sqs.rb, line 36</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">credentials</span>)
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">credentials</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">!=</span> <span class="ruby-constant">Hash</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">credentials</span>[<span class="ruby-string">'EC2_ACCESS_KEY'</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@EC2_ACCESS_KEY</span> = <span class="ruby-identifier">credentials</span>[<span class="ruby-string">'EC2_ACCESS_KEY'</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">credentials</span>[<span class="ruby-string">'EC2_SECRET_KEY'</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">BadConfigurationException</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-ivar">@EC2_SECRET_KEY</span> = <span class="ruby-identifier">credentials</span>[<span class="ruby-string">'EC2_SECRET_KEY'</span>]

  <span class="ruby-ivar">@sqs</span> = <span class="ruby-constant">AWS</span><span class="ruby-operator">::</span><span class="ruby-constant">SQS</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:access_key_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@EC2_ACCESS_KEY</span>,
    <span class="ruby-value">:secret_access_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@EC2_SECRET_KEY</span>)
  <span class="ruby-ivar">@queue</span> = <span class="ruby-ivar">@sqs</span>.<span class="ruby-identifier">queues</span>.<span class="ruby-identifier">create</span>(<span class="ruby-constant">TASK_QUEUE_NAME</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

