<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module HAProxy - RDoc Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>AppController/lib/haproxy.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-app_listen_port">::app_listen_port</a>
    
    <li><a href="#method-c-clear_sites_enabled">::clear_sites_enabled</a>
    
    <li><a href="#method-c-create_app_config">::create_app_config</a>
    
    <li><a href="#method-c-create_app_load_balancer_config">::create_app_load_balancer_config</a>
    
    <li><a href="#method-c-create_app_monitoring_config">::create_app_monitoring_config</a>
    
    <li><a href="#method-c-create_pbserver_config">::create_pbserver_config</a>
    
    <li><a href="#method-c-initialize_config">::initialize_config</a>
    
    <li><a href="#method-c-is_running-3F">::is_running?</a>
    
    <li><a href="#method-c-regenerate_config">::regenerate_config</a>
    
    <li><a href="#method-c-reload">::reload</a>
    
    <li><a href="#method-c-remove_app">::remove_app</a>
    
    <li><a href="#method-c-restart">::restart</a>
    
    <li><a href="#method-c-server_config">::server_config</a>
    
    <li><a href="#method-c-stop">::stop</a>
    
    <li><a href="#method-c-update_app_config">::update_app_config</a>
    
    <li><a href="#method-c-write_app_config">::write_app_config</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    
    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./AppControllerClient.html">AppControllerClient</a>
  
    <li><a href="./AppScaleException.html">AppScaleException</a>
  
    <li><a href="./BadConfigurationException.html">BadConfigurationException</a>
  
    <li><a href="./BlobServer.html">BlobServer</a>
  
    <li><a href="./Collectd.html">Collectd</a>
  
    <li><a href="./CronHelper.html">CronHelper</a>
  
    <li><a href="./Djinn.html">Djinn</a>
  
    <li><a href="./DjinnJobData.html">DjinnJobData</a>
  
    <li><a href="./DjinnServer.html">DjinnServer</a>
  
    <li><a href="./Ejabberd.html">Ejabberd</a>
  
    <li><a href="./FailedZooKeeperOperationException.html">FailedZooKeeperOperationException</a>
  
    <li><a href="./GodInterface.html">GodInterface</a>
  
    <li><a href="./HAProxy.html">HAProxy</a>
  
    <li><a href="./HelperFunctions.html">HelperFunctions</a>
  
    <li><a href="./InfrastructureManagerClient.html">InfrastructureManagerClient</a>
  
    <li><a href="./JSONClient.html">JSONClient</a>
  
    <li><a href="./LoadBalancer.html">LoadBalancer</a>
  
    <li><a href="./Monitoring.html">Monitoring</a>
  
    <li><a href="./NeptuneManagerClient.html">NeptuneManagerClient</a>
  
    <li><a href="./Nginx.html">Nginx</a>
  
    <li><a href="./Object.html">Object</a>
  
    <li><a href="./PbServer.html">PbServer</a>
  
    <li><a href="./RabbitMQ.html">RabbitMQ</a>
  
    <li><a href="./Repo.html">Repo</a>
  
    <li><a href="./UserAppClient.html">UserAppClient</a>
  
    <li><a href="./ZKInterface.html">ZKInterface</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module HAProxy</h1>

  <div id="description" class="description">
    
<p>As AppServers within AppScale are usually single-threaded, we run multiple
copies of them and load balance traffic to them. Since nginx (our first
load balancer) doesn’t do health checks on the AppServer before it
dispatches traffic to it, we employ haproxy, an open source load balancer
that does provide this capability. This module abstracts away configuration
and deployment for haproxy.</p>

  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="BASE_CONFIG_FILE">BASE_CONFIG_FILE
        
        <dd class="description"><p>Provides a set of default configurations.</p>
        
      
        <dt id="CONFIG_EXTENSION">CONFIG_EXTENSION
        
        <dd class="description">
        
      
        <dt id="HAPROXY_PATH">HAPROXY_PATH
        
        <dd class="description">
        
      
        <dt id="MAIN_CONFIG_FILE">MAIN_CONFIG_FILE
        
        <dd class="description"><p>The configuration file that haproxy reads from.</p>
        
      
        <dt id="SERVER_OPTIONS">SERVER_OPTIONS
        
        <dd class="description"><p>Options to used to configure servers. For more information see <a
href="http://haproxy.1wt.eu/download/1.3/doc/configuration.txt">haproxy.1wt.eu/download/1.3/doc/configuration.txt</a></p>
        
      
        <dt id="SITES_ENABLED_PATH">SITES_ENABLED_PATH
        
        <dd class="description">
        
      
        <dt id="START_PORT">START_PORT
        
        <dd class="description"><p>The first port that haproxy will bind to for App Engine apps.</p>
        
      
      </dl>
    </section>
    

    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-app_listen_port" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">app_listen_port</span><span
            class="method-args">(app_number)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>The port that the load balancer will be listening on for the given app
number</p>
          

          
          <div class="method-source-code" id="app_listen_port-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 70</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
  <span class="ruby-constant">START_PORT</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">app_number</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- app_listen_port-source -->
          
        </div>

        

        
      </div><!-- app_listen_port-method -->

    
      <div id="method-c-clear_sites_enabled" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clear_sites_enabled</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Removes all the enabled sites</p>
          

          
          <div class="method-source-code" id="clear_sites_enabled-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 208</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">clear_sites_enabled</span>
  <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>)
    <span class="ruby-identifier">sites</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">entries</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>)
    <span class="ruby-comment"># Remove any files that are not configs</span>
    <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">site</span>.<span class="ruby-identifier">end_with?</span>(<span class="ruby-constant">CONFIG_EXTENSION</span>) }
    <span class="ruby-identifier">full_path_sites</span> = <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-identifier">site</span>) }
    <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm_f</span> <span class="ruby-identifier">full_path_sites</span>

    <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clear_sites_enabled-source -->
          
        </div>

        

        
      </div><!-- clear_sites_enabled-method -->

    
      <div id="method-c-create_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_config</span><span
            class="method-args">(my_public_ip, my_private_ip, listen_port, server_ports, name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>A generic function for creating haproxy config files used by appscale
services</p>
          

          
          <div class="method-source-code" id="create_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 94</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">listen_port</span>, 
  <span class="ruby-identifier">server_ports</span>, <span class="ruby-identifier">name</span>)
  <span class="ruby-identifier">servers</span> = []
  <span class="ruby-identifier">server_ports</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">port</span>, <span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">servers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">server_config</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">port</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">config</span> = <span class="ruby-node">&quot;# Create a load balancer for the #{name} application \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;listen #{name} #{my_private_ip}:#{listen_port} \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)

  <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-node">&quot;#{name}.#{CONFIG_EXTENSION}&quot;</span>)
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_config-source -->
          
        </div>

        

        
      </div><!-- create_app_config-method -->

    
      <div id="method-c-create_app_load_balancer_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_load_balancer_config</span><span
            class="method-args">(my_public_ip, my_private_ip, listen_port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the configuration file for the AppLoadBalancer Rails application</p>
          

          
          <div class="method-source-code" id="create_app_load_balancer_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 75</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_load_balancer_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, 
  <span class="ruby-identifier">listen_port</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">listen_port</span>, 
    <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">server_ports</span>, <span class="ruby-constant">LoadBalancer</span>.<span class="ruby-identifier">name</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_load_balancer_config-source -->
          
        </div>

        

        
      </div><!-- create_app_load_balancer_config-method -->

    
      <div id="method-c-create_app_monitoring_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_app_monitoring_config</span><span
            class="method-args">(my_public_ip, my_private_ip, listen_port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the configuration file for the AppMonitoring Rails application</p>
          

          
          <div class="method-source-code" id="create_app_monitoring_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 82</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_monitoring_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">listen_port</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_public_ip</span>, <span class="ruby-identifier">my_private_ip</span>, <span class="ruby-identifier">listen_port</span>, 
    <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">server_ports</span>, <span class="ruby-constant">Monitoring</span>.<span class="ruby-identifier">name</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_app_monitoring_config-source -->
          
        </div>

        

        
      </div><!-- create_app_monitoring_config-method -->

    
      <div id="method-c-create_pbserver_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">create_pbserver_config</span><span
            class="method-args">(my_ip, listen_port, table)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Create the config file for PBServer applications</p>
          

          
          <div class="method-source-code" id="create_pbserver_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 88</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_pbserver_config</span>(<span class="ruby-identifier">my_ip</span>, <span class="ruby-identifier">listen_port</span>, <span class="ruby-identifier">table</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">create_app_config</span>(<span class="ruby-identifier">my_ip</span>, <span class="ruby-identifier">my_ip</span>, <span class="ruby-identifier">listen_port</span>, 
    <span class="ruby-constant">PbServer</span>.<span class="ruby-identifier">get_server_ports</span>(<span class="ruby-identifier">table</span>), <span class="ruby-constant">PbServer</span><span class="ruby-operator">::</span><span class="ruby-constant">NAME</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- create_pbserver_config-source -->
          
        </div>

        

        
      </div><!-- create_pbserver_config-method -->

    
      <div id="method-c-initialize_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">initialize_config</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Set up the folder structure and creates the configuration files necessary
for haproxy</p>
          

          
          <div class="method-source-code" id="initialize_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 221</span>
  <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">initialize_config</span>
    <span class="ruby-identifier">base_config</span> = <span class="ruby-string">&quot;global
  maxconn 64000
  ulimit-n 200000

  # log incoming requests - may need to tell syslog to accept these requests
  # http://kevin.vanzonneveld.net/techblog/article/haproxy_logging/
  log             127.0.0.1       local0
  log             127.0.0.1       local1 notice

  # Distribute the health checks with a bit of randomness
  spread-checks 5

  # Bind socket for haproxy stats
  stats socket /etc/haproxy/stats

# Settings in the defaults section apply to all services (unless overridden in a specific config)
defaults

  # apply log settings from the global section above to services
  log global

  # Proxy incoming traffic as HTTP requests
  mode http

  # Use round robin load balancing, however since we will use maxconn that will take precedence
  balance roundrobin

  maxconn 64000

  # Log details about HTTP requests
  #option httplog

  # Abort request if client closes its output channel while waiting for the 
  # request. HAProxy documentation has a long explanation for this option.
  option abortonclose

  # Check if a &quot;Connection: close&quot; header is already set in each direction,
  # and will add one if missing.
  option httpclose

  # If sending a request fails, try to send it to another, 3 times
  # before aborting the request
  retries 3

  # Do not enforce session affinity (i.e., an HTTP session can be served by 
  # any Mongrel, not just the one that started the session
  option redispatch

  # Timeout a request if the client did not read any data for 60 seconds
  timeout client 60000

  # Timeout a request if Mongrel does not accept a connection for 60 seconds
  timeout connect 60000

  # Timeout a request if Mongrel does not accept the data on the connection,
  # or does not send a response back in 60 seconds
  timeout server 60000
  
  # Enable the statistics page 
  stats enable
  stats uri     /haproxy?stats
  stats realm   Haproxy\ Statistics
  stats auth    haproxy:stats

  # Create a monitorable URI which returns a 200 if haproxy is up
  # monitor-uri /haproxy?monitor

  # Amount of time after which a health check is considered to have timed out
  timeout check 5000
&quot;</span>

    <span class="ruby-comment"># Create the sites enabled folder</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span> <span class="ruby-constant">SITES_ENABLED_PATH</span>
      <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">mkdir_p</span> <span class="ruby-constant">SITES_ENABLED_PATH</span>
    <span class="ruby-keyword">end</span>
    
    <span class="ruby-comment"># Write the base configuration file which sets default configuration parameters</span>
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">BASE_CONFIG_FILE</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">base_config</span>) }
  <span class="ruby-keyword">end</span></pre>
          </div><!-- initialize_config-source -->
          
        </div>

        

        
      </div><!-- initialize_config-method -->

    
      <div id="method-c-is_running-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_running?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_running-3F-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 60</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">is_running?</span>
  <span class="ruby-identifier">processes</span> = <span class="ruby-value">%xps ax | grep haproxy | grep -v grep | wc -l`</span>.<span class="ruby-identifier">chomp</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">processes</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;0&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_running-3F-source -->
          
        </div>

        

        
      </div><!-- is_running-3F-method -->

    
      <div id="method-c-regenerate_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">regenerate_config</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Generates a load balancer configuration file. Since haproxy doesn’t
provide an file include option we emulate that functionality here.</p>
          

          
          <div class="method-source-code" id="regenerate_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 113</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">regenerate_config</span>
  <span class="ruby-identifier">conf</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">MAIN_CONFIG_FILE</span>,<span class="ruby-string">&quot;w+&quot;</span>)
  
  <span class="ruby-comment"># Start by writing in the base file</span>
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">BASE_CONFIG_FILE</span>, <span class="ruby-string">&quot;r&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">base</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">conf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">base</span>.<span class="ruby-identifier">read</span>())
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">sites</span> = <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">entries</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>)
  <span class="ruby-comment"># Remove any files that are not configs</span>
  <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span> <span class="ruby-operator">!</span><span class="ruby-identifier">site</span>.<span class="ruby-identifier">end_with?</span>(<span class="ruby-constant">CONFIG_EXTENSION</span>) }

  <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">sort!</span>

  <span class="ruby-comment"># Append each one of the configs into the main one</span>
  <span class="ruby-identifier">sites</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">site</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">conf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-string">&quot;\n&quot;</span>)
    <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-identifier">site</span>), <span class="ruby-string">&quot;r&quot;</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">site_config</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">conf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">site_config</span>.<span class="ruby-identifier">read</span>())
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">conf</span>.<span class="ruby-identifier">write</span>(<span class="ruby-string">&quot;\n&quot;</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">conf</span>.<span class="ruby-identifier">close</span>()
  
  <span class="ruby-comment"># Restart haproxy since we have changed the config</span>
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">restart</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- regenerate_config-source -->
          
        </div>

        

        
      </div><!-- regenerate_config-method -->

    
      <div id="method-c-reload" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reload</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="reload-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 56</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reload</span>
  <span class="ruby-value">%xservice haproxy reload`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reload-source -->
          
        </div>

        

        
      </div><!-- reload-method -->

    
      <div id="method-c-remove_app" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_app</span><span
            class="method-args">(app_name)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_app-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 200</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">remove_app</span>(<span class="ruby-identifier">app_name</span>)
  <span class="ruby-identifier">config_name</span> = <span class="ruby-node">&quot;gae_#{app_name}.#{CONFIG_EXTENSION}&quot;</span>
  <span class="ruby-constant">FileUtils</span>.<span class="ruby-identifier">rm</span>(<span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, <span class="ruby-identifier">config_name</span>))
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_app-source -->
          
        </div>

        

        
      </div><!-- remove_app-method -->

    
      <div id="method-c-restart" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">restart</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="restart-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 52</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">restart</span>
  <span class="ruby-value">%xservice haproxy restart`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- restart-source -->
          
        </div>

        

        
      </div><!-- restart-method -->

    
      <div id="method-c-server_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">server_config</span><span
            class="method-args">(app_name, index, ip, port)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Generate the server configuration line for the provided inputs</p>
          

          
          <div class="method-source-code" id="server_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 143</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">server_config</span> <span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>
  <span class="ruby-node">&quot;  server #{app_name}-#{index} #{ip}:#{port} #{SERVER_OPTIONS}&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- server_config-source -->
          
        </div>

        

        
      </div><!-- server_config-method -->

    
      <div id="method-c-stop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">stop</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="stop-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 48</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">stop</span>
  <span class="ruby-value">%xservice haproxy stop`</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- stop-source -->
          
        </div>

        

        
      </div><!-- stop-method -->

    
      <div id="method-c-update_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_app_config</span><span
            class="method-args">(app_name, app_number, ports, public_ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Updates the <a href="HAProxy.html">HAProxy</a> config file for this App
Engine application to point to all the ports currently the application. In
contrast with <a
href="HAProxy.html#method-c-write_app_config">::write_app_config</a>, these
ports can be non-contiguous. TODO(cgb): Lots of copypasta here with <a
href="HAProxy.html#method-c-write_app_config">::write_app_config</a> -
eliminate it.</p>
          

          
          <div class="method-source-code" id="update_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 175</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">update_app_config</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">ports</span>, <span class="ruby-identifier">public_ip</span>)
  <span class="ruby-comment"># Add a prefix to the app name to avoid collisions with non-GAE apps</span>
  <span class="ruby-identifier">full_app_name</span> = <span class="ruby-node">&quot;gae_#{app_name}&quot;</span>
  <span class="ruby-identifier">index</span> = <span class="ruby-value">0</span>
  <span class="ruby-identifier">servers</span> = []

  <span class="ruby-identifier">ports</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">port</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">server</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">server_config</span>(<span class="ruby-identifier">full_app_name</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">public_ip</span>, <span class="ruby-identifier">port</span>)
    <span class="ruby-identifier">index</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-identifier">servers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">server</span>
  }

  <span class="ruby-identifier">listen_port</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
  <span class="ruby-identifier">config</span> = <span class="ruby-node">&quot;# Create a load balancer for the app #{app_name} \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;listen #{full_app_name} #{public_ip}:#{listen_port} \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)

  <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, 
    <span class="ruby-node">&quot;#{full_app_name}.#{CONFIG_EXTENSION}&quot;</span>)
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }
 
  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>()
<span class="ruby-keyword">end</span></pre>
          </div><!-- update_app_config-source -->
          
        </div>

        

        
      </div><!-- update_app_config-method -->

    
      <div id="method-c-write_app_config" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">write_app_config</span><span
            class="method-args">(app_name, app_number, num_of_servers, ip)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="write_app_config-source">
            <pre><span class="ruby-comment"># File AppController/lib/haproxy.rb, line 147</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">write_app_config</span>(<span class="ruby-identifier">app_name</span>, <span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">num_of_servers</span>, <span class="ruby-identifier">ip</span>)
  <span class="ruby-comment"># Add a prefix to the app name to avoid possible conflicts</span>
  <span class="ruby-identifier">full_app_name</span> = <span class="ruby-node">&quot;gae_#{app_name}&quot;</span>

  <span class="ruby-identifier">servers</span> = []
  <span class="ruby-identifier">num_of_servers</span>.<span class="ruby-identifier">times</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">index</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">port</span> = <span class="ruby-constant">HelperFunctions</span>.<span class="ruby-identifier">application_port</span>(<span class="ruby-identifier">app_number</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">num_of_servers</span>)
    <span class="ruby-identifier">server</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">server_config</span>(<span class="ruby-identifier">full_app_name</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">ip</span>, <span class="ruby-identifier">port</span>)
    <span class="ruby-identifier">servers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">server</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">listen_port</span> = <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">app_listen_port</span>(<span class="ruby-identifier">app_number</span>)
  <span class="ruby-identifier">config</span> = <span class="ruby-node">&quot;# Create a load balancer for the app #{app_name} \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;listen #{full_app_name} #{ip}:#{listen_port} \n&quot;</span>
  <span class="ruby-identifier">config</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;\n&quot;</span>)

  <span class="ruby-identifier">config_path</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">join</span>(<span class="ruby-constant">SITES_ENABLED_PATH</span>, 
    <span class="ruby-node">&quot;#{full_app_name}.#{CONFIG_EXTENSION}&quot;</span>)
  <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">config_path</span>, <span class="ruby-string">&quot;w+&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">dest_file</span><span class="ruby-operator">|</span> <span class="ruby-identifier">dest_file</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">config</span>) }

  <span class="ruby-constant">HAProxy</span>.<span class="ruby-identifier">regenerate_config</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- write_app_config-source -->
          
        </div>

        

        
      </div><!-- write_app_config-method -->

    
    </section><!-- public-class-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

